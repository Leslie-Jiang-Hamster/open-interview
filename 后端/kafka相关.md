## 什么是 kafka?

kafka 是一个分布式的发布-订阅消息系统和一个强大的队列，可以处理大量的数据，并可以将消息从一个端点传递到另一个端点。Kafka 适合离线和在线消费消息。Kafka 消息保存在磁盘上，并在集群内复制以防止数据丢失。

## 为什么要使用 kafka?

1.缓冲和消峰：上游数据有突发流量时，下游可能抗不住，而 kafka 可以在中间起一个缓冲的作用，把消息暂存在 kafka 中，下游可以慢慢的消费 kafka 中的消息

2.解耦和扩展性:消息队列可以作为一个接口层，解耦重要的业务流程。

3.异步处理:有些操作并不需要立即执行，可以将其写入 kafka，异步执行

4.kafka 可以堆积请求，即使消费者挂掉也不影响主要业务的正常进行

5.通过 kafka 可以使得一个生产的消息可以被不同业务的消费者消费

## kafka 的架构

kafka 包含多个核心组件 消费者，生产者，Broker,Topic,Partition,Zookeeper,Controller,Replication

消费者从 broker 从取消息，生产者向 broker 发消息

Broker 是一个 kafka 实例，kafka 集群由多个 broker 组成，一个 broker 包含多个 topic，kafka 通过 topic 对消息进行分类，生产者和消费者向指定的 topic 生产和消费消息

Partition 是为了实现扩展性，提高并发能力，将一个 topic 分成多个 Partition，每个 Partition 都是一个有序队列，每个 Partition 分布在不同的 broker

Replication 用于实现备份的功能，保证集群中某个节点故障，该分区的数据不会丢失并且能够正常工作，一个 partition 有多个副本，一个副本有一个 leader 和多个 follower

leader 每个分区多个副本中的主副本，负责接收生产者发送的消息，负责给消费者提供消息

follower 每个分区多个副本中的从副本，负责从主副本中同步数据，当主副本宕机的时候，还会成为新的主副本

offset 表示消费者消息的位置信息

zookeeper 负责存储和管理 kafka 的集群信息

## kafka 会丢失消息吗？如何解决

首先消息的传递有 2 个阶段，从生产者发送给主副本，消费者从主副本消费数据

在生产者发送给主副本的这个阶段，有一个配置参数 ack,ack=0 表示生产者发送消息之后，不等待主副本的响应直接返回，很容易造成消息丢失。ack=1 表示当接收到主副本接收成功就放回，ack=-1 或 all 时表示所有主副本和同步副本集都接收成功时才表示成功

在消费者从主副本消费数据的阶段，有两个操作，一个是处理数据，一个是提交 offset，这个操作的顺序可以由系统参数解决。先处理数据，再提交 offset，可能在提交 offset 之前消费者宕机，导致消息被重复消费。如果先提交 offset，再处理数据，可能会导致数据丢失。

## 导致 kafka 消费顺序乱序的原因？如何解决

1.一个主题存在多个分区，消息分散在不同的分区上，导致消息乱序

2.生产者 ACK 机制中开启 ack=0，先发送的数据因为网络拥塞而延迟，后发送的数据先到达，导致消息乱序

3.生产者开启多批发送，同时发送两个批次的数据，前一个批次的数据超时，重试后顺序发生改变。

解决办法

1.1 一个主题只设置一个分区

1.2 生产者通过 key 指定发往的分区，从而保证有序

2.将 ack 参数设置为 1 或-1

3.将参数设置为一次只发送一批的数据，或启用幂等生产者

## Kafka 组消费之 Rebalance 机制

rebalance，让所有消费者达成共识。触发 Rebalance 机制的条件包括消费组成员发生变化，分区数量发生变化,订阅的主题数量发生变化

当消费组刚创建时，每个消费者会创建消费者协调器实例，然后获取对应的组协调器(通过向任意一个 broker 发起寻找组协调器的请求)，向组协调器请求加入消费组。第一个加入消费组的消费者将成为 leader，然后 leader 将进行选择分区分配策略。包括按分区号排序进行均分，顺序轮流分配，均衡分配并且尽量保持与上次相同。分配好分配后将分区结果同步给消费者

## Kafka 如何保证高可用

1.Kafka 采用集群架构，由多个 broker 组成，每个 broker 存储一部分数据，当某个 broker 宕机，其他 broker 也可以正常工作

2.kafka 通过数据冗余来保证高可用，每个主题由多个分区组成，每个分区分布在不同的 broker 上，并在多个 broker 上复制，即使某个 broker 故障，也可以从其他的 broker 获取数据

3.消费组 kafka 的消费组可以保证消息的高可用，一个消费组包含多个消费者，每个消费者负责某个分区的消息，当某个消费者宕机，其他消费者会接替他的工作

4.监控和故障转移 kafka 会实时监控集群的状况，当某个 broker 出现故障时，会进行故障转移，将该 broker 的分区迁移到其他的 broker 上。保证数据的可用性

## Kafka 的 ISR 机制

ISR 是指同步副本集，与 leader 保持同步的所有副本的集合。当某个副本，落后 leader 太多时，会被移除 ISR 列表，当落后的副本追上 leader 时，又会重新加入 ISR 列表，当 leader 宕机时，会从 ISR 列表从选取一个副本作为 leader。在生产者的 ACK 机制中，ack=-1 或 all 时，也需要等待所有 ISR 列表中的副本都收到消息时，才返回响应。从而保证 kafka 的可靠性和可用性
